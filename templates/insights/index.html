<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>健身洞察 Web</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    let renderFormat = 'text';
    let currentTemplateId = null;

    function csrfToken() {
      const hidden = document.getElementById('csrf-token');
      if (hidden) return hidden.value;
      const name = 'csrftoken';
      const cookies = document.cookie.split(';');
      for (const c of cookies) {
        const [k, v] = c.trim().split('=');
        if (k === name) return decodeURIComponent(v);
      }
      return '';
    }
    async function postForm(url, data) {
      let form;
      if (data instanceof FormData) {
        form = data;
      } else {
        form = new FormData();
        Object.entries(data || {}).forEach(([k, v]) => {
          if (v !== undefined && v !== null) form.append(k, v);
        });
      }
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken() },
        body: form
      });
      return res.json();
    }
    async function getJson(url) {
      const res = await fetch(url);
      return res.json();
    }
    function formatNum(val) {
      const num = Number(val);
      return Number.isFinite(num) ? num.toFixed(2) : (val ?? 'N/A');
    }
    function formatVal(val) {
      if (val === null || val === undefined || val === '') return 'N/A';
      if (typeof val === 'number' || (!isNaN(val) && val !== '')) return formatNum(val);
      return val;
    }
    async function handleImport() {
      const fileInput = document.getElementById('csvFile');
      const status = document.getElementById('status');
      status.textContent = '导入中...';
      const data = fileInput.files.length ? { file: fileInput.files[0] } : {};
      const result = await postForm('/api/import', data);
      status.textContent = result.ok ? `导入完成：${result.rows} 行` : `导入失败：${result.error}`;
      if (result.ok) {
        await refreshUsers();
        await refreshTemplates();
      }
    }
    async function handleSeed() {
      const status = document.getElementById('status');
      status.textContent = '刷新模板...';
      const result = await postForm('/api/seed', {});
      status.textContent = result.ok ? '模板已刷新' : `失败：${result.error}`;
      if (result.ok) await refreshTemplates();
    }
    async function renderTemplate(id) {
      currentTemplateId = id;
      const fmt = renderFormat;
      const userSelect = document.getElementById('userSelect');
      const userVal = userSelect.value || '';
      const status = document.getElementById('status');
      status.textContent = '渲染中...';
      const result = await postForm('/api/render', { template_id: id, format: fmt, user_id: userVal });
      if (result.ok) {
        const output = document.getElementById('output');
        if ((result.format || fmt) === 'markdown') {
          output.innerHTML = marked.parse(result.content || '');
        } else if ((result.format || fmt) === 'html') {
          output.innerHTML = result.content;
        } else {
          output.textContent = result.content;
        }
        status.textContent = '完成';
      } else {
        status.textContent = `渲染失败：${result.error}`;
      }
    }

    function setRenderFormat(fmt) {
      renderFormat = fmt;
      const buttons = ['text', 'markdown', 'html'];
      buttons.forEach(key => {
        const btn = document.getElementById(`fmt-${key}`);
        if (!btn) return;
        if (key === fmt) {
          btn.classList.add('bg-slate-900', 'text-white');
          btn.classList.remove('bg-slate-200', 'text-slate-800');
        } else {
          btn.classList.remove('bg-slate-900', 'text-white');
          btn.classList.add('bg-slate-200', 'text-slate-800');
        }
      });
      if (currentTemplateId) {
        renderTemplate(currentTemplateId);
      }
    }
    async function loadSummary() {
      const res = await getJson('/api/summary');
      if (!res.ok) {
        document.getElementById('summary').textContent = `汇总失败：${res.error}`;
        return;
      }
      const s = res.summary;
      const parts = [];
      if (s.calories_by_workout) {
        parts.push('<h3 class="font-semibold mt-2">按训练类型燃烧</h3><ul class="list-disc ml-5">');
        s.calories_by_workout.forEach(r => {
          parts.push(`<li>${r.workout_type}: ${r.avg_calories} kcal, ${r.avg_duration} hrs, ${r.sessions} sessions</li>`);
        });
        parts.push('</ul>');
      }
      if (s.top_deficit) {
        parts.push('<h3 class="font-semibold mt-2">热量赤字 Top5</h3><ul class="list-disc ml-5">');
        s.top_deficit.forEach(r => {
          parts.push(`<li>User ${r.user_id} (${r.gender}, ${r.age}y): ${r.cal_balance} kcal, ${r.session_duration} hrs</li>`);
        });
        parts.push('</ul>');
      }
      if (s.macro_averages) {
        parts.push('<h3 class="font-semibold mt-2">宏量平均</h3>');
        parts.push(`<p>碳水 ${s.macro_averages.carbs} g | 蛋白 ${s.macro_averages.proteins} g | 脂肪 ${s.macro_averages.fats} g | 热量 ${s.macro_averages.calories} kcal</p>`);
      }
      if (s.efficiency) {
        parts.push('<h3 class="font-semibold mt-2">训练效率</h3><ul class="list-disc ml-5">');
        s.efficiency.forEach(r => {
          parts.push(`<li>${r.workout_type}: 效率 ${r.avg_efficiency} | 专注 ${r.avg_focus} | 恢复 ${r.avg_recovery}</li>`);
        });
        parts.push('</ul>');
      }
      document.getElementById('summary').innerHTML = parts.join('');
    }
    async function refreshTemplates() {
      const res = await getJson('/api/templates');
      if (!res.ok) return;
      const container = document.getElementById('templates');
      container.innerHTML = '';
      res.templates.forEach(t => {
        const btn = document.createElement('button');
        btn.className = 'w-full text-left px-3 py-2 rounded bg-slate-100 hover:bg-slate-200 mb-2';
        btn.textContent = `[${t.id}] ${t.name}`;
        btn.onclick = () => renderTemplate(t.id);
        container.appendChild(btn);
      });
    }
    async function refreshUsers() {
      const res = await getJson('/api/users');
      if (!res.ok) return;
      const sel = document.getElementById('userSelect');
      sel.innerHTML = '<option value="">所有用户（平均）</option>';
      res.users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u;
        opt.textContent = `用户 ${u}`;
        sel.appendChild(opt);
      });
    }

    // 用户管理相关函数
    let currentEditingUserId = null;
    let userPage = 1;
    let userPageSize = 20;
    let userTotal = 0;
    let userOrder = 'desc';

    async function loadUserManagement(page = userPage) {
      userPage = page;
      const res = await getJson(`/api/users/detail?page=${userPage}&page_size=${userPageSize}&order=${userOrder}`);
      if (!res.ok) {
        document.getElementById('userManagementStatus').textContent = `加载失败：${res.error}`;
        return;
      }
      userTotal = res.total || 0;
      const totalPages = Math.max(1, Math.ceil(userTotal / userPageSize));
      if (userPage > totalPages) userPage = totalPages;

      const tbody = document.getElementById('userTableBody');
      tbody.innerHTML = '';

      res.users.forEach(user => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-slate-50 cursor-pointer';
        row.onclick = () => viewUserDetail(user.user_id);
        row.innerHTML = `
          <td class="px-4 py-2">${user.user_id}</td>
          <td class="px-4 py-2">${formatVal(user.age)}</td>
          <td class="px-4 py-2">${user.gender || 'N/A'}</td>
          <td class="px-4 py-2">${formatVal(user.weight)}</td>
          <td class="px-4 py-2">${formatVal(user.height)}</td>
          <td class="px-4 py-2">${user.bmi ? formatNum(user.bmi) : 'N/A'}</td>
          <td class="px-4 py-2">
            <button onclick="event.stopPropagation(); editUser(${user.user_id})" 
                    class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">编辑</button>
            <button onclick="event.stopPropagation(); deleteUserConfirm(${user.user_id})" 
                    class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600 ml-1">删除</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      document.getElementById('userManagementStatus').textContent = `共 ${res.total} 个用户`;
      document.getElementById('userPaginationInfo').textContent = `第 ${userPage} / ${totalPages} 页`;
      document.getElementById('userPrevBtn').disabled = userPage <= 1;
      document.getElementById('userNextBtn').disabled = userPage >= totalPages;
    }

    async function viewUserDetail(userId) {
      const res = await getJson(`/api/users/get?user_id=${userId}`);
      if (!res.ok) {
        alert(`加载失败：${res.error}`);
        return;
      }

      const user = res.user;
      const stats = res.statistics || {};

      let html = `<div class="space-y-2"><h3 class="font-semibold text-lg">用户 ${userId} 详情</h3>`;
      html += '<div class="grid grid-cols-2 gap-2 text-sm">';

      const labelMap = {
        age: '年龄',
        gender: '性别',
        weight: '体重(kg)',
        height: '身高(m)',
        bmi: 'BMI',
        fat_percentage: '体脂率(%)',
        lean_mass_kg: '瘦体重(kg)',
        workout_frequency: '训练频率(次/周)',
        water_intake: '饮水量(L)',
        resting_bpm: '静息心率(BPM)',
      };

      Object.entries(user).forEach(([key, value]) => {
        if (key === 'user_id') return;
        const label = labelMap[key] || key;
        html += `<div><span class="font-medium">${label}:</span> ${formatVal(value)}</div>`;
      });

      html += '</div>';

      if (stats.workout_stats && Object.keys(stats.workout_stats).length > 0) {
        html += '<h4 class="font-semibold mt-4">训练统计</h4><ul class="list-disc ml-5 text-sm">';
        const workoutFields = [
          ['total_calories', '总热量 (kcal)'],
          ['avg_calories', '平均热量 (kcal)'],
          ['avg_duration', '平均时长 (小时)'],
        ];
        workoutFields.forEach(([k, label]) => {
          if (k in stats.workout_stats) {
            html += `<li>${label}: ${formatVal(stats.workout_stats[k])}</li>`;
          }
        });
        html += '</ul>';
      }

      if (stats.nutrition_stats && Object.keys(stats.nutrition_stats).length > 0) {
        html += '<h4 class="font-semibold mt-4">营养统计</h4><ul class="list-disc ml-5 text-sm">';
        const nutritionFields = [
          ['avg_calories', '平均热量 (kcal)'],
          ['avg_proteins', '平均蛋白 (g)'],
          ['avg_carbs', '平均碳水 (g)'],
          ['avg_fats', '平均脂肪 (g)'],
        ];
        nutritionFields.forEach(([k, label]) => {
          if (k in stats.nutrition_stats) {
            html += `<li>${label}: ${formatVal(stats.nutrition_stats[k])}</li>`;
          }
        });
        html += '</ul>';
      }

      if (stats.analysis_stats && Object.keys(stats.analysis_stats).length > 0) {
        html += '<h4 class="font-semibold mt-4">分析统计</h4><ul class="list-disc ml-5 text-sm">';
        const analysisFields = [
          ['avg_cal_balance', '平均热量平衡 (kcal)'],
          ['avg_training_efficiency', '训练效率'],
          ['avg_recovery_index', '恢复指数'],
        ];
        analysisFields.forEach(([k, label]) => {
          if (k in stats.analysis_stats) {
            html += `<li>${label}: ${formatVal(stats.analysis_stats[k])}</li>`;
          }
        });
        html += '</ul>';
      }

      html += '</div>';
      document.getElementById('userDetailContent').innerHTML = html;
    }

    function openUserForm(userId = null) {
      currentEditingUserId = userId;
      const modal = document.getElementById('userFormModal');
      const form = document.getElementById('userForm');

      if (userId) {
        // 编辑模式：加载用户数据
        getJson(`/api/users/get?user_id=${userId}`).then(res => {
          if (res.ok && res.user) {
            Object.keys(res.user).forEach(key => {
              const input = form.querySelector(`[name="${key}"]`);
              if (input && res.user[key] !== null) {
                input.value = res.user[key];
              }
            });
            document.getElementById('userFormTitle').textContent = '编辑用户';
          }
        });
      } else {
        // 创建模式：清空表单
        form.reset();
        document.getElementById('userFormTitle').textContent = '创建新用户';
      }

      modal.classList.remove('hidden');
    }

    function closeUserForm() {
      document.getElementById('userFormModal').classList.add('hidden');
      currentEditingUserId = null;
    }

    async function submitUserForm() {
      const form = document.getElementById('userForm');
      const formData = new FormData(form);

      // 前端校验：至少填写一个字段
      const hasValue = Array.from(formData.values()).some(v => v !== null && v !== undefined && String(v).trim() !== '');
      if (!hasValue) {
        alert('请至少填写一个用户字段');
        return;
      }

      if (currentEditingUserId) {
        formData.append('user_id', currentEditingUserId);
        const res = await postForm('/api/users/update', formData);
        if (res.ok) {
          alert('用户更新成功！');
          closeUserForm();
          loadUserManagement(userPage);
          refreshUsers();
        } else {
          alert(`更新失败：${res.error}`);
        }
      } else {
        const res = await postForm('/api/users/create', formData);
        if (res.ok) {
          alert(`用户创建成功！ID: ${res.user_id}`);
          closeUserForm();
          loadUserManagement(1);
          refreshUsers();
        } else {
          alert(`创建失败：${res.error}`);
        }
      }
    }

    function editUser(userId) {
      openUserForm(userId);
    }

    function deleteUserConfirm(userId) {
      if (!confirm(`确定要删除用户 ${userId} 吗？`)) return;

      const cascade = confirm('是否同时删除关联数据（训练、营养等）？');
      const formData = new FormData();
      formData.append('user_id', userId);
      formData.append('cascade', cascade);

      postForm('/api/users/delete', formData).then(res => {
        if (res.ok) {
          alert('用户删除成功！');
          loadUserManagement(userPage);
          refreshUsers();
        } else {
          alert(`删除失败：${res.error}`);
        }
      });
    }

    function openUserManagement() {
      document.getElementById('userManagementModal').classList.remove('hidden');
      loadUserManagement(1);
    }

    function closeUserManagement() {
      document.getElementById('userManagementModal').classList.add('hidden');
    }

    document.addEventListener('DOMContentLoaded', () => {
      setRenderFormat('text');
      refreshTemplates();
      refreshUsers();
      loadSummary();
    });
  </script>
</head>

<body class="bg-slate-50 text-slate-900">
  <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
  <div class="max-w-6xl mx-auto p-6 space-y-4">
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold">健身洞察 Web</h1>
      </div>
      <div class="flex items-center gap-4">
        <button onclick="openUserManagement()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
          用户管理
        </button>
        <span id="status" class="text-sm text-slate-600">就绪</span>
      </div>
    </header>

    <div
      class="p-4 bg-white rounded border border-slate-200 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h2 class="font-semibold">数据导入 / 重置</h2>
        <p class="text-xs text-slate-600">不选文件时使用根目录的默认 CSV（Final_data (1).csv）覆盖写入。</p>
      </div>
      <div class="flex flex-col sm:flex-row sm:items-center gap-2">
        <input type="file" id="csvFile" accept=".csv" class="text-sm" />
        <button onclick="handleImport()"
          class="px-4 py-2 bg-amber-600 text-white rounded hover:bg-amber-700">导入/重置数据库</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <aside class="lg:col-span-1 space-y-3">
        <div class="p-4 bg-white rounded border border-slate-200 space-y-3">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">模板管理</h2>
            <button onclick="handleSeed()" class="px-3 py-1 text-xs bg-slate-800 text-white rounded">刷新</button>
          </div>
          <div>
            <label class="text-sm text-slate-700">用户筛选</label>
            <select id="userSelect" class="w-full border rounded px-2 py-1 text-sm"></select>
          </div>
        </div>

        <div class="p-4 bg-white rounded border border-slate-200 h-[520px] overflow-auto">
          <h2 class="font-semibold mb-2">模板列表</h2>
          <div id="templates" class="space-y-2"></div>
        </div>
      </aside>

      <main class="lg:col-span-2 space-y-3">
        <div class="p-4 bg-white rounded border border-slate-200 min-h-[240px]">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
              <h2 class="font-semibold">输出</h2>
              <div class="flex items-center gap-1">
                <button id="fmt-text" class="px-3 py-1 text-xs rounded bg-slate-900 text-white" onclick="setRenderFormat('text')">Text</button>
                <button id="fmt-markdown" class="px-3 py-1 text-xs rounded bg-slate-200 text-slate-800" onclick="setRenderFormat('markdown')">Markdown</button>
                <button id="fmt-html" class="px-3 py-1 text-xs rounded bg-slate-200 text-slate-800" onclick="setRenderFormat('html')">HTML</button>
              </div>
            </div>
            <span class="text-xs text-slate-500">点击左侧模板</span>
          </div>
          <div id="output" class="prose max-w-none whitespace-pre-wrap text-sm text-slate-800"></div>
        </div>
        <div class="p-4 bg-white rounded border border-slate-200">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">汇总</h2>
            <button onclick="loadSummary()" class="px-3 py-1 text-xs bg-slate-800 text-white rounded">刷新</button>
          </div>
          <div id="summary" class="text-sm mt-2 space-y-2"></div>
        </div>
      </main>
    </div>
  </div>

  <!-- 用户管理模态框 -->
  <div id="userManagementModal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="p-4 border-b flex items-center justify-between">
        <h2 class="text-xl font-bold">用户管理</h2>
        <div class="flex items-center gap-4">
          <span id="userManagementStatus" class="text-sm text-slate-600"></span>
          <button onclick="openUserForm()"
            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">创建用户</button>
          <button onclick="closeUserManagement()"
            class="px-4 py-2 bg-slate-600 text-white rounded hover:bg-slate-700">关闭</button>
        </div>
      </div>
      <div class="flex-1 overflow-hidden flex">
        <div class="flex-1 overflow-auto p-4 space-y-3">
          <div class="flex items-center gap-3 text-sm">
            <span id="userPaginationInfo" class="text-slate-600">第 1 / 1 页</span>
            <button id="userPrevBtn" class="px-3 py-1 bg-slate-200 rounded disabled:opacity-50"
              onclick="loadUserManagement(Math.max(1, userPage - 1))">上一页</button>
            <button id="userNextBtn" class="px-3 py-1 bg-slate-200 rounded disabled:opacity-50"
              onclick="loadUserManagement(userPage + 1)">下一页</button>
            <label class="flex items-center gap-1">每页
              <select class="border rounded px-2 py-1"
                onchange="userPageSize = Number(this.value); loadUserManagement(1);">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </label>
            <label class="flex items-center gap-1">排序
              <select class="border rounded px-2 py-1" onchange="userOrder = this.value; loadUserManagement(1);">
                <option value="desc" selected>按 ID 降序</option>
                <option value="asc">按 ID 升序</option>
              </select>
            </label>
          </div>
          <table class="w-full border-collapse">
            <thead>
              <tr class="bg-slate-100">
                <th class="px-4 py-2 text-left border">ID</th>
                <th class="px-4 py-2 text-left border">年龄</th>
                <th class="px-4 py-2 text-left border">性别</th>
                <th class="px-4 py-2 text-left border">体重(kg)</th>
                <th class="px-4 py-2 text-left border">身高(m)</th>
                <th class="px-4 py-2 text-left border">BMI</th>
                <th class="px-4 py-2 text-left border">操作</th>
              </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
          </table>
        </div>
        <div class="w-80 border-l p-4 overflow-auto">
          <h3 class="font-semibold mb-2">用户详情</h3>
          <div id="userDetailContent" class="text-sm">点击用户行查看详情</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 用户表单模态框 -->
  <div id="userFormModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-auto">
      <div class="p-4 border-b flex items-center justify-between">
        <h2 id="userFormTitle" class="text-xl font-bold">创建新用户</h2>
        <button onclick="closeUserForm()"
          class="px-4 py-2 bg-slate-600 text-white rounded hover:bg-slate-700">关闭</button>
      </div>
      <form id="userForm" class="p-4 space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">年龄 (Age)</label>
            <input type="number" name="age" step="0.1" class="w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">性别 (Gender)</label>
            <select name="gender" class="w-full border rounded px-3 py-2">
              <option value="">请选择</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">体重 (Weight, kg)</label>
            <input type="number" name="weight" step="0.1" class="w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">身高 (Height, m)</label>
            <input type="number" name="height" step="0.01" min="0" class="w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">体脂率 (Fat %)</label>
            <input type="number" name="fat_percentage" step="0.1" class="w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">瘦体重 (Lean Mass, kg)</label>
            <input type="number" name="lean_mass_kg" step="0.1" class="w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">训练频率 (Workout Frequency/week)</label>
            <input type="number" name="workout_frequency" step="0.1" class="w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">饮水量 (Water Intake, L)</label>
            <input type="number" name="water_intake" step="0.1" class="w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">静息心率 (Resting BPM)</label>
            <input type="number" name="resting_bpm" step="0.1" class="w-full border rounded px-3 py-2">
          </div>
        </div>
        <div class="flex justify-end gap-2 pt-4 border-t">
          <button type="button" onclick="closeUserForm()"
            class="px-4 py-2 bg-slate-400 text-white rounded hover:bg-slate-500">取消</button>
          <button type="button" onclick="submitUserForm()"
            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">保存</button>
        </div>
      </form>
    </div>
  </div>
</body>

</html>
